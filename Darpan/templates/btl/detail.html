{% extends "base/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ proposal.title }}{% endblock %}

{% block navbar %}
{% include "base/navbar.html" %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-1">{{ proposal.title }}</h2>
            <p class="text-muted mb-0">
                Proposed by <strong>{{ proposal.user.full_name }}</strong> on {{ proposal.created_at|date:"M j, Y" }}
            </p>
        </div>
        <div class="text-end">
            <span class="badge rounded-pill px-3 py-2 mb-2 fs-6
                {% if proposal.status == 'draft' %}bg-secondary
                {% elif proposal.status == 'submitted' %}bg-info text-dark
                {% elif proposal.status == 'approved' %}bg-success
                {% elif proposal.status == 'rejected' %}bg-danger
                {% elif proposal.status == 'completed' %}bg-primary
                {% endif %}">
                {{ proposal.get_status_display }}
            </span>
            <div class="fs-4 fw-bold">â‚¹{{ proposal.budget }}</div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Details -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Proposal Details</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <small class="text-muted d-block">Location</small>
                            <strong>{{ proposal.location }}</strong>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block">Proposed Date</small>
                            <strong>{{ proposal.proposed_date|date:"l, F j, Y" }}</strong>
                        </div>
                    </div>
                    <div class="mb-0">
                        <small class="text-muted d-block">Description</small>
                        <p class="mb-0">{{ proposal.description|linebreaks }}</p>
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Activity Images</h5>
                    {% if proposal.user == user %}
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#uploadForm">
                        <i data-lucide="upload" style="width:14px;height:14px;"></i> Upload
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <!-- Upload Form -->
                    <div class="collapse mb-4" id="uploadForm">
                        <div class="card card-body bg-light border-0">
                            <form method="post" action="{% url 'btl:upload_image' proposal.pk %}"
                                enctype="multipart/form-data">
                                {% csrf_token %}
                                {{ image_form|crispy }}
                                <button type="submit" class="btn btn-primary btn-sm mt-2">Upload Image</button>
                            </form>
                        </div>
                    </div>

                    {% if images %}
                    <div class="row g-3">
                        {% for img in images %}
                        <div class="col-md-4">
                            <div class="card h-100">
                                <a href="{{ img.image.url }}" target="_blank">
                                    <img src="{{ img.image.url }}" class="card-img-top" alt="{{ img.caption }}"
                                        style="height: 150px; object-fit: cover;">
                                </a>
                                <div class="card-body p-2">
                                    <span class="badge bg-secondary mb-1">{{ img.get_image_type_display }}</span>
                                    {% if img.caption %}
                                    <p class="card-text small text-muted text-truncate">{{ img.caption }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center py-3">No images uploaded yet.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Approval Action -->
            {% if approval_form %}
            <div class="card border-primary mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Approval Action</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'btl:action' proposal.pk %}">
                        {% csrf_token %}
                        {{ approval_form|crispy }}
                        <button type="submit" class="btn btn-primary mt-3">Submit Decision</button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Rejection Reason -->
            {% if proposal.status == 'rejected' and proposal.rejection_reason %}
            <div class="alert alert-danger">
                <strong>Rejection Reason:</strong> {{ proposal.rejection_reason }}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Actions -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Actions</h5>
                    <div class="d-grid gap-2">
                        {% if proposal.status == 'draft' and proposal.user == user %}
                        <a href="{% url 'btl:edit' proposal.pk %}" class="btn btn-outline-primary">
                            <i data-lucide="edit-2" class="me-2"></i> Edit Proposal
                        </a>

                        <form method="post" action="{% url 'btl:submit' proposal.pk %}" class="d-grid">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success"
                                onclick="return confirm('Are you sure you want to submit this proposal?');">
                                <i data-lucide="send" class="me-2"></i> Submit for Approval
                            </button>
                        </form>
                        {% endif %}

                        <a href="{% url 'btl:list' %}" class="btn btn-outline-secondary">
                            <i data-lucide="arrow-left" class="me-2"></i> Back to List
                        </a>
                    </div>
                </div>
            </div>

            <!-- Timeline/Info -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Details</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <small class="text-muted d-block">Proposal ID</small>
                            <strong>#{{ proposal.pk }}</strong>
                        </li>
                        <li class="mb-2">
                            <small class="text-muted d-block">Created</small>
                            {{ proposal.created_at|date:"M j, Y H:i" }}
                        </li>
                        {% if proposal.current_approver %}
                        <li class="mb-2">
                            <small class="text-muted d-block">Current Approver</small>
                            <span class="badge bg-warning text-dark">{{ proposal.current_approver.full_name }}</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}