{% extends "base/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Import Data{% endblock %}

{% block navbar %}
{% include "base/navbar.html" %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Import Form -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h4 class="mb-0"><i data-lucide="upload" class="me-2" style="width:20px;"></i>Import Data</h4>
                    <a href="{% url 'analytics:dashboard' %}" class="btn btn-outline-secondary btn-sm">Back</a>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading"><i data-lucide="info" class="me-1" style="width:16px;"></i>Supported
                            Files</h6>
                        <ul class="mb-0 small">
                            <li><strong>Sales Data:</strong> Transaction records with amounts and products</li>
                            <li><strong>Stock Data:</strong> Inventory with quantities and prices</li>
                            <li><strong>CRM Report:</strong> Customer visit and lead data</li>
                        </ul>
                    </div>

                    <div class="alert alert-warning mb-4">
                        <h6 class="alert-heading"><i data-lucide="alert-triangle" class="me-1"
                                style="width:16px;"></i>Transaction Rules</h6>
                        <div class="small">
                            <span class="badge bg-success me-2">FF = Sale (+)</span>
                            <span class="badge bg-danger me-2">7DE/7DR/LB/LE/LU = Return (-)</span>
                            <span class="badge bg-secondary">RI/RR = Ignored</span>
                        </div>
                    </div>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label class="form-label fw-bold">Data Type</label>
                            {{ form.file_type }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">File</label>
                            {{ form.data_file }}
                            <small class="text-muted">Accepts CSV and Excel files</small>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i data-lucide="upload-cloud" class="me-2" style="width:18px;"></i>Upload & Import
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Recent Imports -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0"><i data-lucide="history" class="me-2" style="width:18px;"></i>Recent Imports</h5>
                    <a href="{% url 'analytics:import_history' %}" class="btn btn-sm btn-link">View All</a>
                </div>
                <div class="card-body p-0">
                    {% if recent_imports %}
                    <ul class="list-group list-group-flush">
                        {% for log in recent_imports %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="badge bg-{{ log.file_type|default:'secondary' }} me-2">
                                        {{ log.get_file_type_display }}
                                    </span>
                                    <small class="text-muted">{{ log.file_name|truncatechars:30 }}</small>
                                </div>
                                <small class="text-muted">{{ log.imported_at|timesince }} ago</small>
                            </div>
                            <div class="mt-1 small">
                                <span class="text-success">{{ log.rows_imported }} imported</span>
                                {% if log.rows_skipped %}<span class="text-warning ms-2">{{ log.rows_skipped }}
                                    skipped</span>{% endif %}
                                {% if log.rows_ignored %}<span class="text-secondary ms-2">{{ log.rows_ignored }}
                                    ignored</span>{% endif %}
                            </div>
                            {% if log.columns_unmapped %}
                            <div class="mt-1">
                                <small class="text-danger">
                                    <i data-lucide="alert-circle" style="width:12px;"></i>
                                    Unmapped: {{ log.columns_unmapped|join:", "|truncatechars:50 }}
                                </small>
                            </div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i data-lucide="inbox" style="width:32px; height:32px;"></i>
                        <p class="mt-2 mb-0">No imports yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Links -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i data-lucide="link" class="me-2" style="width:18px;"></i>Analytics</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'analytics:sales_kpis' %}" class="btn btn-outline-primary">
                            <i data-lucide="trending-up" class="me-2" style="width:16px;"></i>Sales KPIs
                        </a>
                        <a href="{% url 'analytics:stock_kpis' %}" class="btn btn-outline-success">
                            <i data-lucide="package" class="me-2" style="width:16px;"></i>Stock KPIs
                        </a>
                        <a href="{% url 'analytics:list' %}" class="btn btn-outline-secondary">
                            <i data-lucide="list" class="me-2" style="width:16px;"></i>View Records
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}